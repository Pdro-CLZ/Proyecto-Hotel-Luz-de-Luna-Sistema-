{% extends 'base.html' %}
{% block title %}Gestionar Zona{% endblock %}

{% block content %}
{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Gestionar Zona</title>
    <link rel="stylesheet" href="{% static 'personal/css/styles1.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="menu-bg">
    <div class="menu-container">

        <div class="menu-header" style="display:flex; justify-content: space-between; align-items: center;">
            <h2>Gestión de Zona: {{ zona.nombre }}</h2>
            <div>
                <button class="boton-verde" onclick="window.location.href='/limpieza/zonas/estado'">Volver</button>
            </div>
        </div>
                    {% if mensaje_alerta %}
            <div class="alert alert-danger mt-3">{{ mensaje_alerta }}</div>
            {% endif %}
        <div class="zona-info" style="border: 1px solid #ccc; border-radius: 10px; padding: 20px; margin-top: 20px;">
            <p><strong>Nombre:</strong> {{ zona.nombre }}</p>
            <p><strong>Es habitación:</strong> {{ zona.es_habitacion|yesno:"Sí,No" }}</p>
            <p><strong>Detalles:</strong> {{ zona.detalles }}</p>

            {% if zona.foto %}
            <div style="text-align:center; margin: 15px 0;">
                <img src="{{ zona.foto.url }}" alt="Foto de la zona" style="max-width:200px; max-height:200px; border-radius:8px; object-fit:cover;">
            </div>
            {% endif %}

            <div class="mt-3">
                <p><strong>Estado Actual:</strong> {{ zona.estado }}</p>
            </div>

            <div class="row align-items-center mt-2">
                <div class="col-md-4 text-end"><strong>Cambiar de estado:</strong></div>
                <div class="col-md-5">
                    <form method="post" action="">
                        {% csrf_token %}
                        <input type="hidden" name="cambiar_estado_zona" value="1">
                        <div class="d-flex">
                            <select name="nuevo_estado" class="form-select" style="width: 150px; height: 50px; margin-top: 15px;" required>
                                <option value="" disabled selected>Seleccione...</option>
                                <option value="Limpio (Disponible)">Limpio (Disponible)</option>
                                <option value="Parcialmente Limpio (Disponible)">Parcialmente Limpio (Disponible)</option>
                                <option value="Sucio (Disponible)">Sucio (Disponible)</option>
                                <option value="Sucio (No Disponible)">Sucio (No Disponible)</option>
                            </select>
                            <button type="submit" class="boton-verde" style="margin-left: 30px;">Confirmar</button>
                        </div>
                    </form>
                </div>
            </div>

        </div>

        <h3 style="margin-top: 30px; margin-bottom: 15px;">Tareas de esta zona:</h3>

        <div style="overflow-x:auto;">
            <table class="menu-table">
                <thead>
                    <tr>
                        <th></th>
                        <th>Nombre</th>
                        <th>Estado</th>
                        <th>Observaciones</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tarea in tareas %}
                    <tr>
                        <td>
                            <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#modalTarea{{ tarea.id }}">Ver más</button>
                        </td>
                        <td>{{ tarea.nombre }}</td>
                        <td>
                            {% if tarea.estado == "Pendiente" %}
                                <span class="badge bg-secondary">Pendiente</span>
                            {% else %}
                                <span class="badge bg-success">Realizada</span>
                            {% endif %}
                        </td>
                        <td>{{ tarea.observaciones_empleado|default:"Sin observaciones" }}</td>
                        <td>
                            {% if tarea.estado == "Pendiente" %}
                            <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#modalObservacion{{ tarea.id }}">
                                Marcar como Realizada
                            </button>
                            {% else %}
                            <button class="btn btn-sm btn-secondary" data-bs-toggle="modal" data-bs-target="#modalObservacion{{ tarea.id }}">
                                Marcar como Pendiente
                            </button>
                            {% endif %}
                        </td>
                    </tr>

                    <div class="modal fade" id="modalTarea{{ tarea.id }}" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">{{ tarea.nombre }}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <p><strong>Detalles:</strong> {{ tarea.detalles }}</p>
                                    <p><strong>Estado:</strong> {{ tarea.estado }}</p>
                                    <p><strong>Observaciones:</strong> {{ tarea.observaciones_empleado|default:"Sin observaciones" }}</p>
                                    {% if tarea.foto %}
                                    <div style="text-align:center; margin: 10px 0;">
                                        <img src="{{ tarea.foto.url }}" alt="Foto de la tarea" style="max-width:150px; max-height:150px; border-radius:5px; object-fit:cover;">
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-dark" data-bs-dismiss="modal">OK</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="modal fade" id="modalObservacion{{ tarea.id }}" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <form method="post" action="{% url 'cambiar_estado_tarea' tarea.id %}">
                                    {% csrf_token %}
                                    <div class="modal-header">
                                        <h5 class="modal-title">Observaciones - {{ tarea.nombre }}</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <label for="observaciones{{ tarea.id }}" class="form-label">¿Desea agregar alguna observación?</label>
                                        <textarea name="observaciones" id="observaciones{{ tarea.id }}" rows="3" class="form-control" placeholder="Escriba aquí (opcional)..."></textarea>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                        <button type="submit" class="btn btn-primary">Guardar</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    {% empty %}
                    <tr>
                        <td colspan="5" style="text-align:center;">No hay tareas registradas en esta zona.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
{% endblock %}
