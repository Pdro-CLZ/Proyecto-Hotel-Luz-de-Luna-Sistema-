{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Reporte de Rendimiento del Personal</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-light">
<div class="container py-4">
  <h2 class="text-center mb-4">Reporte de Rendimiento del Personal</h2>

  <!-- FILTROS -->
  <form method="get" class="row g-3 mb-4">
    <div class="col-md-3">
      <label class="form-label">Área de trabajo</label>
      <select name="area" class="form-select">
        <option value="">Todas</option>
        {% for a in areas %}
          <option value="{{ a.id }}" {% if area_id == a.id|stringformat:"s" %}selected{% endif %}>{{ a.nombre }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-3">
      <label class="form-label">Empleado</label>
      <select name="empleado" class="form-select">
        <option value="">Todos</option>
        {% for d in data %}
          <option value="{{ d.empleado.id }}" {% if empleado_id == d.empleado.id|stringformat:"s" %}selected{% endif %}>
            {{ d.empleado.nombre }} {{ d.empleado.apellido }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-2">
      <label class="form-label">Mes</label>
      <input type="number" min="1" max="12" name="mes" value="{{ mes }}" class="form-control">
    </div>

    <div class="col-md-2">
      <label class="form-label">Año</label>
      <input type="number" name="anio" value="{{ anio }}" class="form-control">
    </div>

    <div class="col-md-2 d-flex align-items-end">
      <button class="btn btn-primary w-100">Aplicar Filtros</button>
    </div>
  </form>

  <!-- BOTONES EXPORTAR -->
  <div class="mb-4 text-end">
    <a href="?exportar=excel{% if area_id %}&area={{ area_id }}{% endif %}{% if empleado_id %}&empleado={{ empleado_id }}{% endif %}{% if mes %}&mes={{ mes }}{% endif %}{% if anio %}&anio={{ anio }}{% endif %}" 
       class="btn btn-success me-2">Exportar Excel</a>

    <a href="?exportar=pdf{% if area_id %}&area={{ area_id }}{% endif %}{% if empleado_id %}&empleado={{ empleado_id }}{% endif %}{% if mes %}&mes={{ mes }}{% endif %}{% if anio %}&anio={{ anio }}{% endif %}" 
       class="btn btn-danger">Exportar PDF</a>
  </div>

  <!-- TABLA PRINCIPAL -->
  <h5>Métricas Generales</h5>
  <table class="table table-striped table-sm align-middle">
    <thead class="table-light">
      <tr>
        <th>Empleado</th>
        <th>Área</th>
        <th>Asistencias</th>
        <th>Promedio Horas</th>
        <th>Puntualidad</th>
        <th>Tareas Completadas</th>
      </tr>
    </thead>
    <tbody>
      {% for d in data %}
      <tr {% if empleado_id == d.empleado.id|stringformat:"s" %}class="table-info"{% endif %}>
        <td>{{ d.empleado }}</td>
        <td>{{ d.area }}</td>
        <td>{{ d.total_asistencias }}</td>
        <td>{{ d.promedio_horas }}</td>
        <td>{{ d.puntualidad_pct }}%</td>
        <td>{{ d.tareas_completadas }}</td>
      </tr>
      {% empty %}
      <tr><td colspan="6" class="text-center text-muted">Sin registros</td></tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- DETALLE DE EMPLEADO SELECCIONADO -->
  {% if detalle_asistencias %}
  <hr>
  <h5>Detalle de asistencias — {{ detalle_asistencias.0.empleado }}</h5>
  <table class="table table-bordered table-sm mt-3">
    <thead class="table-secondary">
      <tr>
        <th>Fecha</th>
        <th>Hora de llegada</th>
        <th>Hora de salida</th>
        <th>Horas trabajadas</th>
      </tr>
    </thead>
    <tbody>
      {% for a in detalle_asistencias %}
      <tr>
        <td>{{ a.fecha|date:"Y-m-d" }}</td>
        <td>{{ a.hora_llegada|default:"—" }}</td>
        <td>{{ a.hora_salida|default:"—" }}</td>
        <td>{{ a.horas_trabajadas|default:"0" }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- GRÁFICO DE DESEMPEÑO -->
  <div class="mt-4">
    <h6>Evolución del desempeño mensual</h6>
    <canvas id="graficoDesempeno" height="100"></canvas>
  </div>

  <!-- Datos seguros para Chart.js -->
  {{ grafico_dias|json_script:"labels-json" }}
  {{ grafico_valores|json_script:"values-json" }}

  <script>
    const labels = JSON.parse(document.getElementById('labels-json').textContent);
    const values = JSON.parse(document.getElementById('values-json').textContent);

    const ctx = document.getElementById('graficoDesempeno');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Horas trabajadas por día',
          data: values,
          borderColor: 'rgba(75,192,192,1)',
          backgroundColor: 'rgba(75,192,192,0.2)',
          fill: true,
          tension: 0.3,
          borderWidth: 2,
          pointRadius: 3
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: true, position: 'top' },
          title: {
            display: true,
            text: 'Evolución del desempeño durante el mes'
          }
        },
        scales: {
          y: { beginAtZero: true, title: { display: true, text: 'Horas trabajadas' } },
          x: { title: { display: true, text: 'Día del mes' } }
        }
      }
    });
  </script>
  {% endif %}
</div>
</body>
</html>
