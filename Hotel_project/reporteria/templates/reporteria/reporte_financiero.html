{% extends 'base.html' %}
{% block title %}Reporte Financiero{% endblock %}

{% block content %}
{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>{{ titulo }} | Reporte Financiero</title>
    <link rel="stylesheet" href="{% static 'personal/css/styles1.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="menu-bg">
<div class="menu-container">

     <div class="menu-header" style="display:flex; justify-content: space-between; align-items: center;">
        <h2>{{ titulo }} del Hotel</h2>
        <div>
            <a href="/reporteria" class="boton-verde">Volver a Reportería</a>
        </div>
    </div>

    <!-- Formulario de filtros -->
    <div class="filtros">
        <form method="get" class="row g-3" style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; align-items: center;">
            <div>
                <label class="form-label">Mes</label>
                <select name="mes" style="padding: 14px 20px; border-radius: 10px; border: 2px solid var(--color-claro); background: white; color: var(--color-texto); font-size: 1em; min-width: 200px;">
                    {% for m,v in meses %}
                        <option value="{{ m }}" {% if mes == m %}selected{% endif %}>{{ v }}</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label class="form-label">Año</label>
                <input type="number" name="anio" style="padding: 14px 20px; border-radius: 10px; border: 2px solid var(--color-claro); background: white; color: var(--color-texto); font-size: 1em; min-width: 150px;" value="{{ anio }}">
            </div>

            <div style="display: flex; gap: 10px;">
                <button type="submit" class="boton-verde" style="min-width: 120px;">Filtrar</button>
                <a href="?mes={{ mes }}&anio={{ anio }}&tipo={{ tipo_reporte }}&exportar=excel" class="boton-neutral" style="min-width: 120px;">Excel</a>
                <a href="?mes={{ mes }}&anio={{ anio }}&tipo={{ tipo_reporte }}&exportar=pdf" class="boton-verde" style="min-width: 120px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">PDF</a>
            </div>
        </form>
    </div>

    <!-- Tablas de ingresos y egresos -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px; margin-top: 30px;">
        <div>
            <h3 style="color: var(--color-principal); margin-bottom: 20px; text-align: center; position: relative; display: inline-block; width: 100%;">
                Ingresos por Categoría
                <span style="position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); width: 40px; height: 3px; background: var(--color-acento); border-radius: 2px;"></span>
            </h3>
            <table class="menu-table">
                <thead>
                    <tr>
                        <th>Categoría</th>
                        <th>Monto</th>
                    </tr>
                </thead>
                <tbody>
                    {% for i in ingresos %}
                        <tr>
                            <td>{{ i.categoria }}</td>
                            <td>${{ i.total }}</td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="2" style="text-align: center; color: var(--color-secundario); font-style: italic;">Sin datos</td>
                        </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr style="background: var(--color-claro);">
                        <th style="color: var(--color-claro);">Total</th>
                        <th style="color: var(--color-claro);">${{ total_ingresos }}</th>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div>
            <h3 style="color: var(--color-principal); margin-bottom: 20px; text-align: center; position: relative; display: inline-block; width: 100%;">
                Egresos por Área
                <span style="position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); width: 40px; height: 3px; background: var(--color-acento); border-radius: 2px;"></span>
            </h3>
            <table class="menu-table">
                <thead>
                    <tr>
                        <th>Área</th>
                        <th>Monto</th>
                    </tr>
                </thead>
                <tbody>
                    {% for e in egresos %}
                        <tr>
                            <td>{{ e.categoria }}</td>
                            <td>${{ e.total }}</td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="2" style="text-align: center; color: var(--color-secundario); font-style: italic;">Sin datos</td>
                        </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr style="background: var(--color-claro);">
                        <th style="color: var(--color-claro);">Total</th>
                        <th style="color: var(--color-claro);">${{ total_egresos }}</th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <!-- Gráfico comparativo -->
    <h3 style="color: var(--color-principal); margin: 40px 0 20px 0; text-align: center; position: relative; display: inline-block; width: 100%;">
        Comparativo con Mes Anterior
        <span style="position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); width: 60px; height: 3px; background: var(--color-acento); border-radius: 2px;"></span>
    </h3>
    
    <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(44, 95, 79, 0.15); border: 1px solid var(--color-claro); margin-bottom: 30px;">
        <canvas id="chartBalance" height="100"></canvas>
    </div>

    <!-- Script del gráfico: usamos el JSON que viene desde la vista -->
    <script>
        const chartData = {{ chart_data|safe }}; 

        const ctx = document.getElementById("chartBalance");

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Ingresos', 'Egresos', 'Utilidad'],
                datasets: [
                    {
                        label: chartData.label_mes_actual,
                        data: chartData.actual_mes,
                        backgroundColor: 'rgba(44, 95, 79, 0.8)',
                        borderColor: 'rgba(44, 95, 79, 1)',
                        borderWidth: 1
                    },
                    {
                        label: chartData.label_mes_anterior,
                        data: chartData.anterior_mes,
                        backgroundColor: 'rgba(139, 115, 85, 0.8)',
                        borderColor: 'rgba(139, 115, 85, 1)',
                        borderWidth: 1
                    },
                    {
                        label: chartData.label_anio_actual,
                        data: chartData.actual_anio,
                        backgroundColor: 'rgba(212, 165, 116, 0.8)',
                        borderColor: 'rgba(212, 165, 116, 1)',
                        borderWidth: 1
                    },
                    {
                        label: chartData.label_anio_anterior,
                        data: chartData.anterior_anio,
                        backgroundColor: 'rgba(58, 120, 99, 0.8)',
                        borderColor: 'rgba(58, 120, 99, 1)',
                        borderWidth: 1
                    },
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        labels: {
                            color: 'var(--color-texto)'
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { 
                            stepSize: 50000,
                            color: 'var(--color-texto)'
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        ticks: {
                            color: 'var(--color-texto)'
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    }
                }
            }
        });
    </script>

    <!-- Resumen final -->
    <div class="message message-success" style="margin-top: 40px; text-align: center;">
        <strong>Resumen:</strong> Ingresos ${{ total_ingresos }} – Egresos ${{ total_egresos }}
        → <strong style="color: white;">Utilidad ${{ utilidad }}</strong>
    </div>
</div>
</body>
</html>
{% endblock %}
