{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>{{ titulo }} | Reporte Financiero</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">
<div class="container py-4">

    <h2 class="mb-4 text-center"> {{ titulo }} del Hotel</h2>

    <!--  Formulario de filtros -->
    <form method="get" class="row g-3 mb-4">

        <div class="col-md-3">
            <label class="form-label">Mes</label>
            <select name="mes" class="form-select">
                {% for m,v in meses %}
                    <option value="{{ m }}" {% if mes == m %}selected{% endif %}>{{ v }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-2">
            <label class="form-label">Año</label>
            <input type="number" name="anio" class="form-control" value="{{ anio }}">
        </div>

        <div class="col-md-2 align-self-end">
            <button class="btn btn-primary w-100">Filtrar</button>
        </div>

        <div class="col-md-2 align-self-end text-end">
            <a href="?mes={{ mes }}&anio={{ anio }}&tipo={{ tipo_reporte }}&exportar=excel" class="btn btn-success w-100 mb-2"> Excel</a>
            <a href="?mes={{ mes }}&anio={{ anio }}&tipo={{ tipo_reporte }}&exportar=pdf" class="btn btn-danger w-100"> PDF</a>
        </div>
    </form>

    <!-- Tablas de ingresos y egresos -->
    <div class="row">
        <div class="col-md-6">
            <h5>Ingresos por Categoría</h5>
            <table class="table table-sm table-striped">
                <thead><tr><th>Categoría</th><th>Monto</th></tr></thead>
                <tbody>
                    {% for i in ingresos %}
                        <tr><td>{{ i.categoria }}</td><td>₡{{ i.total }}</td></tr>
                    {% empty %}
                        <tr><td colspan="2" class="text-center text-muted">Sin datos</td></tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr><th>Total</th><th>₡{{ total_ingresos }}</th></tr>
                </tfoot>
            </table>
        </div>

        <div class="col-md-6">
            <h5>Egresos por Área</h5>
            <table class="table table-sm table-striped">
                <thead><tr><th>Área</th><th>Monto</th></tr></thead>
                <tbody>
                    {% for e in egresos %}
                        <tr><td>{{ e.categoria }}</td><td>₡{{ e.total }}</td></tr>
                    {% empty %}
                        <tr><td colspan="2" class="text-center text-muted">Sin datos</td></tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr><th>Total</th><th>₡{{ total_egresos }}</th></tr>
                </tfoot>
            </table>
        </div>
    </div>

    <!-- Gráfico comparativo -->
    <h5 class="mt-4 text-center">Comparativo con Mes Anterior</h5>
    <canvas id="chartBalance" height="100"></canvas>

    <!--  Datos del gráfico en formato JSON -->
<script id="chart-data" type="application/json">
    {
        "actual_mes": [{{ total_ingresos|floatformat:2 }}, {{ total_egresos|floatformat:2 }}, {{ utilidad|floatformat:2 }}],
        "anterior_mes": [{{ ingresos_mes_ant|floatformat:2 }}, {{ egresos_mes_ant|floatformat:2 }}, {{ utilidad_mes_ant|floatformat:2 }}],
        "actual_anio": [{{ ingresos_anio_act|floatformat:2 }}, {{ egresos_anio_act|floatformat:2 }}, {{ utilidad_anio_act|floatformat:2 }}],
        "anterior_anio": [{{ ingresos_anio_ant|floatformat:2 }}, {{ egresos_anio_ant|floatformat:2 }}, {{ utilidad_anio_ant|floatformat:2 }}],
        "label_mes_actual": "{{ anio }}-{{ mes }}",
        "label_mes_anterior": "Mes anterior",
        "label_anio_actual": "Año {{ anio }}",
        "label_anio_anterior": "Año {{ anio|add:'-1' }}"
    }
</script>

<script>
    const dataEl = document.getElementById("chart-data");
    const chartData = JSON.parse(dataEl.textContent);
    const ctx = document.getElementById("chartBalance");

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Ingresos', 'Egresos', 'Utilidad'],
            datasets: [
                {
                    label: chartData.label_mes_actual,
                    data: chartData.actual_mes,
                    backgroundColor: 'rgba(75, 192, 192, 0.6)',
                },
                {
                    label: chartData.label_mes_anterior,
                    data: chartData.anterior_mes,
                    backgroundColor: 'rgba(255, 99, 132, 0.6)',
                },
                {
                    label: chartData.label_anio_actual,
                    data: chartData.actual_anio,
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                },
                {
                    label: chartData.label_anio_anterior,
                    data: chartData.anterior_anio,
                    backgroundColor: 'rgba(255, 206, 86, 0.6)',
                },
            ]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { stepSize: 50000 }
                }
            }
        }
    });
</script>

    <!-- Resumen final -->
    <div class="alert alert-info mt-4 text-center">
        <strong>Resumen:</strong> Ingresos ₡{{ total_ingresos }} – Egresos ₡{{ total_egresos }}
        → <strong>Utilidad ₡{{ utilidad }}</strong>
    </div>

</div>
</body>
</html>
